{% extends "base.html" %}
{% block content %}
  <article class="viz-page">
    <header class="demo-header">
      <div>
        <h2>Pathfinding Visualization</h2>
        <div class="meta">
          <span class="badge">interactive</span>
          <span class="path">A* and Dijkstra on a grid</span>
        </div>
      </div>
    </header>

    {% if notes %}
      <section class="panel">
        <h3>Algorithm Notes</h3>
        <pre class="notes"><code>{{ notes }}</code></pre>
        <p class="small"><a href="{{ url_for('big_o_guide') }}">Big-O Guide</a></p>
      </section>
    {% endif %}

    <section class="panel">
      <form id="controls" class="viz-controls" onsubmit="return false;">
        <label>
          Algorithm
          <select id="algo">
            {% for a in algorithms %}
              <option value="{{ a.key }}" {% if a.key == algo %}selected{% endif %}>{{ a.name }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          Rows
          <input id="rows" type="range" min="5" max="50" step="1" value="20" />
          <span id="rowsLabel">20</span>
        </label>

        <label>
          Cols
          <input id="cols" type="range" min="5" max="80" step="1" value="30" />
          <span id="colsLabel">30</span>
        </label>

        <label>
          Wall density
          <input id="density" type="range" min="0" max="0.5" step="0.01" value="0.25" />
          <span id="densityLabel">0.25</span>
        </label>

        <label class="row">
          Seed (optional)
          <input id="seed" type="number" step="1" placeholder="random" />
        </label>

        <label>
          Speed (fps)
          <input id="speed" type="range" min="1" max="60" step="1" value="24" />
          <span id="speedLabel">24</span>
        </label>

        <div class="viz-buttons">
          <button id="generate" class="btn" type="button">Generate</button>
          <button id="play" class="btn" type="button">Play</button>
          <button id="pause" class="btn secondary" type="button" disabled>Pause</button>
          <button id="step" class="btn secondary" type="button">Step</button>
          <button id="reset" class="btn secondary" type="button">Reset</button>
        </div>
      </form>
    </section>

    <section class="panel">
      <div id="status" class="viz-status">Ready</div>
      <div id="grid" class="grid"></div>
    </section>
  </article>

  <script>
    const el = (id) => document.getElementById(id);
    const algoSel = el("algo");
    const rowsRange = el("rows");
    const rowsLabel = el("rowsLabel");
    const colsRange = el("cols");
    const colsLabel = el("colsLabel");
    const densityRange = el("density");
    const densityLabel = el("densityLabel");
    const seedInput = el("seed");
    const speedRange = el("speed");
    const speedLabel = el("speedLabel");
    const statusEl = el("status");
    const gridEl = el("grid");
    const btnGenerate = el("generate");
    const btnPlay = el("play");
    const btnPause = el("pause");
    const btnStep = el("step");
    const btnReset = el("reset");

    let frames = [];
    let frameIdx = 0;
    let playing = false;
    let rafId = null;
    let prevTime = 0;
    let frameIntervalMs = 1000 / Number(speedRange.value || 24);
    let rows = Number(rowsRange.value), cols = Number(colsRange.value);
    let start = [0, 0], goal = [rows - 1, cols - 1];
    let wallSet = new Set();

    function setStatus(msg) { statusEl.textContent = msg; }
    function setDisabledDuringPlay(isPlaying) {
      btnGenerate.disabled = isPlaying;
      algoSel.disabled = isPlaying;
      rowsRange.disabled = isPlaying;
      colsRange.disabled = isPlaying;
      densityRange.disabled = isPlaying;
      seedInput.disabled = isPlaying;
      btnPlay.disabled = isPlaying;
      btnPause.disabled = !isPlaying;
    }

    function buildGrid() {
      gridEl.innerHTML = "";
      gridEl.style.setProperty("--rows", rows);
      gridEl.style.setProperty("--cols", cols);
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.r = String(r);
          cell.dataset.c = String(c);
          gridEl.appendChild(cell);
        }
      }
      paintStatic();
    }

    function paintStatic() {
      for (const cell of gridEl.children) {
        cell.classList.remove("wall", "open", "closed", "path", "current", "start", "goal");
      }
      // walls
      for (const w of wallSet) {
        const [r, c] = w.split(",").map(Number);
        const cell = gridEl.querySelector(`div.cell[data-r="${r}"][data-c="${c}"]`);
        if (cell) cell.classList.add("wall");
      }
      // start/goal markers
      const s = gridEl.querySelector(`div.cell[data-r="${start[0]}"][data-c="${start[1]}"]`);
      const g = gridEl.querySelector(`div.cell[data-r="${goal[0]}"][data-c="${goal[1]}"]`);
      if (s) s.classList.add("start");
      if (g) g.classList.add("goal");
    }

    function paintFrame(f) {
      if (!f) return;
      paintStatic();
      const { current, open, closed, path, op } = f;

      for (const [r, c] of open || []) {
        const cell = gridEl.querySelector(`div.cell[data-r="${r}"][data-c="${c}"]`);
        if (cell) cell.classList.add("open");
      }
      for (const [r, c] of closed || []) {
        const cell = gridEl.querySelector(`div.cell[data-r="${r}"][data-c="${c}"]`);
        if (cell) cell.classList.add("closed");
      }
      for (const [r, c] of path || []) {
        const cell = gridEl.querySelector(`div.cell[data-r="${r}"][data-c="${c}"]`);
        if (cell) cell.classList.add("path");
      }
      if (current) {
        const cell = gridEl.querySelector(`div.cell[data-r="${current[0]}"][data-c="${current[1]}"]`);
        if (cell) cell.classList.add("current");
      }
      setStatus(`Frame ${frameIdx + 1}/${frames.length} Â· op=${op}`);
    }

    function stepOnce() {
      if (!frames.length) return;
      frameIdx = Math.min(frames.length - 1, frameIdx + 1);
      paintFrame(frames[frameIdx]);
    }

    function loop(ts) {
      if (!playing) return;
      if (!prevTime) prevTime = ts;
      const delta = ts - prevTime;
      if (delta >= frameIntervalMs) {
        prevTime = ts;
        stepOnce();
        if (frameIdx >= frames.length - 1) {
          playing = false;
          setDisabledDuringPlay(false);
          return;
        }
      }
      rafId = requestAnimationFrame(loop);
    }

    function play() {
      if (!frames.length) return;
      if (frameIdx >= frames.length - 1) frameIdx = 0;
      playing = true;
      prevTime = 0;
      setDisabledDuringPlay(true);
      rafId = requestAnimationFrame(loop);
    }

    function pause() { playing = false; setDisabledDuringPlay(false); if (rafId) cancelAnimationFrame(rafId); }
    function reset() { frameIdx = 0; paintFrame(frames[0]); setStatus("Reset"); }

    async function generate() {
      pause();
      setStatus("Generating...");
      rows = Number(rowsRange.value); cols = Number(colsRange.value);
      const body = {
        algo: algoSel.value,
        rows, cols,
        density: Number(densityRange.value),
        seed: seedInput.value === "" ? null : Number(seedInput.value),
      };
      const res = await fetch("{{ url_for('api_viz_path') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      if (data.error) { setStatus("Error: " + data.error); return; }

      frames = data.frames || [];
      frameIdx = 0;
      start = data.grid.start; goal = data.grid.goal;
      wallSet = new Set(data.grid.walls.map(w => w.join(",")));
      buildGrid();
      paintFrame(frames[0]);
      setStatus(`Generated ${frames.length} frames for ${data.name} (${rows}x${cols})`);
    }

    // Bindings
    rowsRange.addEventListener("input", () => rowsLabel.textContent = rowsRange.value);
    colsRange.addEventListener("input", () => colsLabel.textContent = colsRange.value);
    densityRange.addEventListener("input", () => densityLabel.textContent = densityRange.value);
    speedRange.addEventListener("input", () => { speedLabel.textContent = speedRange.value; frameIntervalMs = 1000 / Number(speedRange.value || 24); });

    btnGenerate.addEventListener("click", generate);
    btnPlay.addEventListener("click", play);
    btnPause.addEventListener("click", pause);
    btnStep.addEventListener("click", stepOnce);
    btnReset.addEventListener("click", reset);

    // Initialize labels and generate
    rowsLabel.textContent = rowsRange.value;
    colsLabel.textContent = colsRange.value;
    densityLabel.textContent = densityRange.value;
    speedLabel.textContent = speedRange.value;

    generate();
  </script>
{% endblock %}
