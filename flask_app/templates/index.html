{% extends "base.html" %}
{% block content %}
  <!-- Dashboard Header with Search -->
  <header class="dashboard-header mb-6">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
      <div class="dashboard-title">
        <h2 class="text-2xl font-bold text-white mb-2">Python DSA Dashboard</h2>
        <div class="dashboard-stats flex flex-wrap gap-4 text-sm text-gray-400">
          <span class="badge-info">{{ total_demos or 134 }} demos</span>
          <span class="badge-info">{{ categories|length or 17 }} categories</span>
          <!-- Removed old completion percentage -->
          {% if remaining_todos %}
            <span class="badge-warning">{{ remaining_todos }} TODOs</span>
          {% endif %}
        </div>
      </div>
      
      <!-- Search and Filter Bar -->
      <div class="dashboard-controls">
        <div class="search-container">
          <input 
            type="search" 
            id="global-search" 
            placeholder="Search algorithms, problems, visualizations..." 
            class="search-input"
            autocomplete="off"
            aria-label="Search all content"
          >
          <div class="search-icon">üîç</div>
        </div>
        
        <div class="filter-controls">
          <select id="category-filter" class="filter-select" aria-label="Filter by category">
            <option value="">All Categories</option>
            {% for category in categories.keys() %}
              <option value="{{ category }}">{{ category|title }}</option>
            {% endfor %}
          </select>
          
          <!-- Removed old status filter -->
        </div>
      </div>
    </div>

    <!-- View Toggle Tabs -->
    <nav class="view-tabs" role="tablist" aria-label="Content views">
      <button class="view-tab active" data-view="all" role="tab" aria-selected="true">
        All Content
      </button>
      <button class="view-tab" data-view="algorithms" role="tab">
        Algorithms
      </button>
      <button class="view-tab" data-view="leetcode" role="tab">
        LeetCode Problems
      </button>
      <button class="view-tab" data-view="visualizations" role="tab">
        Visualizations
      </button>
      <!-- Removed old tab -->
    </nav>
  </header>

  {% if not categories %}
    <div class="empty-state">
      <div class="empty-icon">üìä</div>
      <h3>No demos discovered</h3>
      <p>Ensure modules under <code>src/</code> define a <code>demo()</code> function.</p>
    </div>
  {% else %}
    <!-- Main Content Area -->
    <div class="dashboard-content">
      <!-- All Content View -->
      <div id="all-view" class="content-view active" role="tabpanel">
        <div class="content-grid" id="content-grid">
          {% for category, demos in categories.items() %}
            {% for d in demos %}
              <article class="content-card {{ get_card_type(category, d) }}" 
                       data-category="{{ category }}" 
                       data-id="{{ d.id }}"
                       data-status="{{ get_demo_status(d) }}"
                       data-search-text="{{ (d.title + ' ' + category + ' ' + d.id|string)|lower }}">
                
                <!-- Card Header -->
                <header class="card-header">
                  <div class="card-status-indicator {{ get_demo_status(d) }}"></div>
                  <div class="card-meta">
                    <span class="card-category">{{ category|title }}</span>
                    {% if d.get('difficulty') %}
                      <span class="difficulty-badge {{ d.difficulty.value|lower }}">
                        {{ d.difficulty.value }}
                      </span>
                    {% endif %}
                  </div>
                </header>
                
                <!-- Card Content -->
                <div class="card-body">
                  <h3 class="card-title">{{ d.title }}</h3>
                  
                  {% if d.get('tags') %}
                    <div class="card-tags">
                      {% for tag in d.tags[:3] %}
                        <span class="tag">{{ tag }}</span>
                      {% endfor %}
                      {% if d.tags|length > 3 %}
                        <span class="tag-more">+{{ d.tags|length - 3 }}</span>
                      {% endif %}
                    </div>
                  {% endif %}
                  
                  <div class="card-description">
                    {% if d.get('notes') and d.notes %}
                      {{ d.notes[:100] }}{% if d.notes|length > 100 %}...{% endif %}
                    {% else %}
                      Algorithm implementation with demo and complexity analysis.
                    {% endif %}
                  </div>
                  
                  <!-- Removed old indicator -->
                </div>
                
                <!-- Card Actions -->
                <footer class="card-actions">
                  {% if category == 'visualizations' or (d.id|string).startswith('viz.') %}
                    {% if d.id == 'viz.sorting' %}
                      <a class="btn-primary" href="{{ url_for('viz_sorting') }}">Launch</a>
                    {% elif d.id == 'viz.graph' %}
                      <a class="btn-primary" href="{{ url_for('viz_graph') }}?algo=bfs">Launch</a>
                    {% elif d.id == 'viz.path' %}
                      <a class="btn-primary" href="{{ url_for('viz_path') }}?algo=astar">Launch</a>
                    {% elif d.id == 'viz.arrays' %}
                      <a class="btn-primary" href="{{ url_for('viz_arrays') }}?algo=binary_search">Launch</a>
                    {% elif d.id == 'viz.mst' %}
                      <a class="btn-primary" href="{{ url_for('viz_mst') }}?algo=kruskal">Launch</a>
                    {% elif d.id == 'viz.topo' %}
                      <a class="btn-primary" href="{{ url_for('viz_topo') }}?algo=kahn">Launch</a>
                    {% elif d.id == 'viz.nn' %}
                      <a class="btn-primary" href="{{ url_for('viz_nn') }}?dataset=blobs">Launch</a>
                    {% endif %}
                    <button class="btn-secondary" onclick="showCardDetails('{{ d.id }}')">Details</button>
                  {% else %}
                    <div class="card-action-icons">
                      <button class="btn-icon demo-run-btn" data-module="{{ d.id }}" aria-label="Run Demo">‚ñ∂Ô∏è</button>
                      {% set viz_key = sorting_viz_map.get(d.id) if sorting_viz_map else None %}
                      {% if viz_key %}
                        <a class="btn-icon" href="{{ url_for('viz_sorting') }}?algo={{ viz_key }}" aria-label="Visualize">üìä</a>
                      {% endif %}
                      <a class="btn-icon" href="{{ url_for('source') }}?module={{ d.id }}" aria-label="View Source">üìÑ</a>
                    </div>
                  {% endif %}
                </footer>
                
                <!-- Inline Demo Output Panel -->
                <div class="demo-output-panel" hidden>
                  <div class="output-header">
                    <h4>Demo Output</h4>
                    <button class="btn-icon close-output" aria-label="Close output">√ó</button>
                  </div>
                  <pre class="demo-output" role="status" aria-live="polite"><code></code></pre>
                </div>
              </article>
            {% endfor %}
          {% endfor %}
        </div>
      </div>

    </div>
  {% endif %}

  <!-- Search Results Overlay -->
  <div id="search-results" class="search-overlay" hidden>
    <div class="search-results-container">
      <div class="search-results-header">
        <h3>Search Results</h3>
        <button class="btn-icon close-search" aria-label="Close search">√ó</button>
      </div>
      <div class="search-results-content">
        <div id="search-results-list"></div>
      </div>
    </div>
  </div>

  <script>
    // Dashboard JavaScript
    (function() {
      'use strict';
      
      // State management
      let allCards = [];
      let filteredCards = [];
      let currentView = 'all';
      
      // Initialize dashboard
      function init() {
        allCards = Array.from(document.querySelectorAll('.content-card'));
        filteredCards = [...allCards];
        
        // Event listeners
        document.getElementById('global-search').addEventListener('input', handleSearch);
        document.getElementById('category-filter').addEventListener('change', handleFilters);
        // Removed old status filter listener
        
        // View tabs
        document.querySelectorAll('.view-tab').forEach(tab => {
          tab.addEventListener('click', handleViewChange);
        });
        
        // Demo run buttons
        document.addEventListener('click', handleDemoRun);
        
        // Menu dropdowns
        document.addEventListener('click', handleMenus);
        
        // Removed old initialization
      }
      
      // Search functionality
      function handleSearch(e) {
        const query = e.target.value.toLowerCase().trim();
        
        if (query === '') {
          hideSearchResults();
          showAllCards();
          return;
        }
        
        const results = allCards.filter(card => {
          const searchText = card.dataset.searchText || '';
          return searchText.includes(query);
        });
        
        if (query.length > 2) {
          showSearchResults(results, query);
        } else {
          hideSearchResults();
        }
        
        filterCards(results);
      }
      
      // Filter functionality
      function handleFilters() {
        const categoryFilter = document.getElementById('category-filter').value;
        let filtered = allCards;
        
        if (categoryFilter) {
          filtered = filtered.filter(card => card.dataset.category === categoryFilter);
        }
        
        // Also respect current view
        if (currentView !== 'all') {
          filtered = filtered.filter(card => card.dataset.category === currentView);
        }
        
        filterCards(filtered);
      }
      
      // View management
      function handleViewChange(e) {
        const newView = e.target.dataset.view;
        if (newView === currentView) return;
        
        // Update tab states
        document.querySelectorAll('.view-tab').forEach(tab => {
          tab.classList.remove('active');
          tab.setAttribute('aria-selected', 'false');
        });
        e.target.classList.add('active');
        e.target.setAttribute('aria-selected', 'true');
        
        // Show/hide content views
        document.querySelectorAll('.content-view').forEach(view => {
          view.classList.remove('active');
          view.hidden = true;
        });
        
        const targetView = document.getElementById(newView + '-view');
        if (targetView) {
          targetView.classList.add('active');
          targetView.hidden = false;
        }
        
        currentView = newView;
        
        // Reapply filters when view changes
        handleFilters();
      }
      
      // Demo execution
      async function handleDemoRun(e) {
        const btn = e.target.closest('.demo-run-btn');
        if (!btn) return;
        
        e.preventDefault();
        const moduleId = btn.dataset.module;
        const card = btn.closest('.content-card');
        const outputPanel = card.querySelector('.demo-output-panel');
        const outputCode = outputPanel.querySelector('.demo-output code');
        
        // Show output panel
        outputPanel.hidden = false;
        outputPanel.classList.remove('error');
        outputCode.textContent = '';
        
        // Update button state
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Running...';
        
        try {
          const response = await fetch('/api/demo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ module: moduleId })
          });
          
          const data = await response.json();
          
          if (data.error) {
            outputPanel.classList.add('error');
            outputCode.textContent = data.error;
          } else {
            outputCode.textContent = data.output || '(no output)';
          }
        } catch (error) {
          outputPanel.classList.add('error');
          outputCode.textContent = 'Error: ' + error.message;
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }
      
      // Menu handling
      function handleMenus(e) {
        if (e.target.classList.contains('menu-trigger')) {
          e.stopPropagation();
          const menu = e.target.nextElementSibling;
          menu.classList.toggle('show');
        } else {
          // Close all menus
          document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
          });
        }
        
        if (e.target.classList.contains('close-output')) {
          e.target.closest('.demo-output-panel').hidden = true;
        }
        
        if (e.target.classList.contains('close-search')) {
          hideSearchResults();
        }
      }
      
      // Search results
      function showSearchResults(results, query) {
        const resultsContainer = document.getElementById('search-results-list');
        
        if (results.length === 0) {
          resultsContainer.innerHTML = `<div class="no-results">No results found for "${query}"</div>`;
        } else {
          resultsContainer.innerHTML = results.map(card => {
            const title = card.querySelector('.card-title').textContent;
            const category = card.dataset.category;
            return `
              <div class="search-result-item" data-card-id="${card.dataset.id}">
                <span class="result-title">${title}</span>
                <span class="result-category">${category}</span>
              </div>
            `;
          }).join('');
        }
        
        document.getElementById('search-results').hidden = false;
      }
      
      function hideSearchResults() {
        document.getElementById('search-results').hidden = true;
      }
      
      // Card filtering
      function filterCards(cards) {
        allCards.forEach(card => {
          card.hidden = !cards.includes(card);
        });
      }
      
      function showAllCards() {
        allCards.forEach(card => {
          card.hidden = false;
        });
      }
      
      
      // Global functions
      window.showCardDetails = function(cardId) {
        const card = document.querySelector(`[data-id="${cardId}"]`);
        if (card) {
          const detailsUrl = card.querySelector('a[href*="demo_page"]')?.href;
          if (detailsUrl) {
            window.location.href = detailsUrl;
          }
        }
      };
      
      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
{% endblock %}
