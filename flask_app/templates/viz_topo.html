{% extends "base.html" %}
{% block content %}
  <article class="viz-page">
    <header class="demo-header">
      <div>
        <h2>Topological Sort (Kahn's Algorithm)</h2>
        <div class="meta">
          <span class="badge">interactive</span>
          <span class="path">DAG generation · Zero in-degree queue · Removal order</span>
        </div>
      </div>
    </header>

    <section class="panel">
      <form id="controls" class="viz-controls" onsubmit="return false;">
        <label>
          Algorithm
          <select id="algo">
            {% for a in algorithms %}
              <option value="{{ a.key }}" {% if a.key == algo %}selected{% endif %}>{{ a.name }}</option>
            {% endfor %}
          </select>
        </label>

        <label>
          Nodes (n)
          <input id="n" type="range" min="4" max="40" step="1" value="12" />
          <span id="nLabel">12</span>
        </label>

        <label>
          Layers
          <input id="layers" type="range" min="2" max="8" step="1" value="3" />
          <span id="layersLabel">3</span>
        </label>

        <label>
          Edge Prob (p)
          <input id="p" type="range" min="0" max="1" step="0.01" value="0.35" />
          <span id="pLabel">0.35</span>
        </label>

        <label class="row">
          Seed (optional)
          <input id="seed" type="number" step="1" placeholder="random" />
        </label>

        <label>
          Speed (fps)
          <input id="speed" type="range" min="1" max="60" step="1" value="24" />
          <span id="speedLabel">24</span>
        </label>

        <div class="viz-buttons">
          <button id="generate" class="btn" type="button">Generate</button>
          <button id="play" class="btn" type="button">Play</button>
          <button id="pause" class="btn secondary" type="button" disabled>Pause</button>
          <button id="step" class="btn secondary" type="button">Step</button>
          <button id="reset" class="btn secondary" type="button">Reset</button>
        </div>
      </form>
    </section>

    <section class="panel">
      <div id="status" class="viz-status">Ready</div>
      <svg id="dag" width="100%" height="460" viewBox="0 0 1000 460" preserveAspectRatio="xMidYMid meet">
        <defs>
          <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
            <polygon points="0 0, 6 3, 0 6" fill="rgba(148,163,184,0.7)"></polygon>
          </marker>
          <marker id="arrowhead-active" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
            <polygon points="0 0, 6 3, 0 6" fill="rgba(245,158,11,0.95)"></polygon>
          </marker>
          <marker id="arrowhead-done" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
            <polygon points="0 0, 6 3, 0 6" fill="rgba(34,197,94,0.95)"></polygon>
          </marker>
        </defs>
      </svg>
    </section>
  </article>

  <script>
    const el = (id) => document.getElementById(id);
    const algoSel = el("algo");
    const nRange = el("n");
    const nLabel = el("nLabel");
    const layersRange = el("layers");
    const layersLabel = el("layersLabel");
    const pRange = el("p");
    const pLabel = el("pLabel");
    const seedInput = el("seed");
    const speedRange = el("speed");
    const speedLabel = el("speedLabel");
    const statusEl = el("status");
    const svg = el("dag");

    const btnGenerate = el("generate");
    const btnPlay = el("play");
    const btnPause = el("pause");
    const btnStep = el("step");
    const btnReset = el("reset");

    // State
    let graph = { nodes: [], edges: [] };
    let frames = [];
    let frameIdx = 0;
    let playing = false;
    let rafId = null;
    let prevTime = 0;
    let frameIntervalMs = 1000 / Number(speedRange.value || 24);

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function setDisabledDuringPlay(isPlaying) {
      btnGenerate.disabled = isPlaying;
      algoSel.disabled = isPlaying;
      nRange.disabled = isPlaying;
      pRange.disabled = isPlaying;
      layersRange.disabled = isPlaying;
      seedInput.disabled = isPlaying;
      btnPlay.disabled = isPlaying;
      btnPause.disabled = !isPlaying;
    }

    function keyEdge(u, v) {
      return `${u}-${v}`;
    }

    function clearSvg() {
      svg.innerHTML = `
        <defs>
          <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
            <polygon points="0 0, 6 3, 0 6" fill="rgba(148,163,184,0.7)"></polygon>
          </marker>
          <marker id="arrowhead-active" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
            <polygon points="0 0, 6 3, 0 6" fill="rgba(245,158,11,0.95)"></polygon>
          </marker>
          <marker id="arrowhead-done" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
            <polygon points="0 0, 6 3, 0 6" fill="rgba(34,197,94,0.95)"></polygon>
          </marker>
        </defs>
      `;
    }

    function drawDag() {
      clearSvg();
      const W = 1000, H = 460;

      // Draw edges (u -> v)
      for (const [u, v] of graph.edges) {
        const a = graph.nodes[u], b = graph.nodes[v];
        const x1 = a.x * W, y1 = a.y * H;
        const x2 = b.x * W, y2 = b.y * H;

        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", String(x1));
        line.setAttribute("y1", String(y1));
        line.setAttribute("x2", String(x2));
        line.setAttribute("y2", String(y2));
        line.setAttribute("stroke", "rgba(148,163,184,0.65)");
        line.setAttribute("stroke-width", "2");
        line.setAttribute("marker-end", "url(#arrowhead)");
        line.setAttribute("data-edge", keyEdge(u, v));
        svg.appendChild(line);
      }

      // Draw nodes
      for (const n of graph.nodes) {
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.setAttribute("data-node", String(n.id));

        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", String(n.x * W));
        circle.setAttribute("cy", String(n.y * H));
        circle.setAttribute("r", "12");
        circle.setAttribute("fill", "rgba(96,165,250,0.25)");
        circle.setAttribute("stroke", "rgba(96,165,250,0.55)");
        circle.setAttribute("stroke-width", "2");
        g.appendChild(circle);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", String(n.x * W));
        text.setAttribute("y", String(n.y * H + 4));
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("font-size", "12");
        text.setAttribute("fill", "var(--text)");
        text.textContent = String(n.id);
        g.appendChild(text);

        svg.appendChild(g);
      }
    }

    function paintFrame(f) {
      if (!f) return;

      // Reset styles
      for (const line of svg.querySelectorAll("line")) {
        line.setAttribute("stroke", "rgba(148,163,184,0.65)");
        line.setAttribute("stroke-width", "2");
        line.setAttribute("marker-end", "url(#arrowhead)");
        line.removeAttribute("stroke-dasharray");
      }
      for (const c of svg.querySelectorAll("circle")) {
        c.setAttribute("fill", "rgba(96,165,250,0.25)");
        c.setAttribute("stroke", "rgba(96,165,250,0.55)");
      }

      // Removed nodes (in order)
      for (const v of f.removed || []) {
        const circle = svg.querySelector(`g[data-node="${v}"] circle`);
        if (circle) {
          circle.setAttribute("fill", "rgba(34,197,94,0.45)");
          circle.setAttribute("stroke", "rgba(34,197,94,0.85)");
        }
      }

      // Queue nodes
      for (const v of f.queue || []) {
        const circle = svg.querySelector(`g[data-node="${v}"] circle`);
        if (circle) {
          circle.setAttribute("fill", "rgba(245,158,11,0.35)");
          circle.setAttribute("stroke", "rgba(245,158,11,0.85)");
        }
      }

      // Current node
      if (f.current != null) {
        const circle = svg.querySelector(`g[data-node="${f.current}"] circle`);
        if (circle) {
          circle.setAttribute("fill", "rgba(239,68,68,0.6)");
          circle.setAttribute("stroke", "rgba(239,68,68,0.9)");
        }
      }

      // Highlight edges being inspected/decremented/enqueued
      for (const e of f.highlight_edges || []) {
        const [u, v] = e;
        const line = svg.querySelector(`line[data-edge="${keyEdge(u, v)}"]`);
        if (line) {
          const isDec = (f.op === "decrement" || f.op === "enqueue");
          const isEnq = f.op === "enqueue";
          const color = isEnq ? "rgba(34,197,94,0.95)" : "rgba(245,158,11,0.95)";
          const marker = isEnq ? "url(#arrowhead-done)" : "url(#arrowhead-active)";
          line.setAttribute("stroke", color);
          line.setAttribute("stroke-width", isDec ? "4" : "3");
          if (!isEnq) line.setAttribute("stroke-dasharray", "6,4");
          line.setAttribute("marker-end", marker);
        }
      }

      const order = Array.isArray(f.order) ? f.order.slice() : [];
      const queueStr = Array.isArray(f.queue) ? f.queue.join(",") : "";
      setStatus(`Frame ${frameIdx + 1}/${frames.length} · op=${f.op || "none"} · order=[${order.join(" ")}] · queue=[${queueStr}]`);
    }

    function stepOnce() {
      if (!frames.length) return;
      frameIdx = Math.min(frames.length - 1, frameIdx + 1);
      paintFrame(frames[frameIdx]);
    }

    function loop(ts) {
      if (!playing) return;
      if (!prevTime) prevTime = ts;
      const delta = ts - prevTime;
      if (delta >= frameIntervalMs) {
        prevTime = ts;
        stepOnce();
        if (frameIdx >= frames.length - 1) {
          playing = false;
          setDisabledDuringPlay(false);
          return;
        }
      }
      rafId = requestAnimationFrame(loop);
    }

    function play() {
      if (!frames.length) return;
      if (frameIdx >= frames.length - 1) frameIdx = 0;
      playing = true;
      prevTime = 0;
      setDisabledDuringPlay(true);
      rafId = requestAnimationFrame(loop);
    }

    function pause() {
      playing = false;
      setDisabledDuringPlay(false);
      if (rafId) cancelAnimationFrame(rafId);
    }

    function reset() {
      frameIdx = 0;
      if (frames.length) {
        paintFrame(frames[0]);
      }
      setStatus("Reset");
    }

    async function generate() {
      pause();
      setStatus("Generating...");
      const body = {
        algo: algoSel.value,
        n: Number(nRange.value),
        layers: Number(layersRange.value),
        p: Number(pRange.value),
        seed: seedInput.value === "" ? null : Number(seedInput.value),
      };
      const res = await fetch("{{ url_for('api_viz_topo') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      if (data.error) {
        setStatus("Error: " + data.error);
        return;
      }

      graph = data.graph;
      frames = data.frames || [];
      frameIdx = 0;
      drawDag();
      if (frames.length) {
        paintFrame(frames[0]);
      }
      setStatus(`Generated ${frames.length} frames for ${data.name} (n=${data.n}, layers=${data.layers}, p=${data.p})`);
    }

    // Bindings
    nRange.addEventListener("input", () => (nLabel.textContent = nRange.value));
    layersRange.addEventListener("input", () => (layersLabel.textContent = layersRange.value));
    pRange.addEventListener("input", () => (pLabel.textContent = pRange.value));
    speedRange.addEventListener("input", () => {
      speedLabel.textContent = speedRange.value;
      frameIntervalMs = 1000 / Number(speedRange.value || 24);
    });
    btnGenerate.addEventListener("click", generate);
    btnPlay.addEventListener("click", play);
    btnPause.addEventListener("click", pause);
    btnStep.addEventListener("click", stepOnce);
    btnReset.addEventListener("click", reset);

    // Initialize labels and generate
    nLabel.textContent = nRange.value;
    layersLabel.textContent = layersRange.value;
    pLabel.textContent = pRange.value;
    speedLabel.textContent = speedRange.value;

    generate();
  </script>
{% endblock %}
